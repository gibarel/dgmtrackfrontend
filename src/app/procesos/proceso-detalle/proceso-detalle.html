<div class="wrap">
  <div class="topbar">
    <button class="btn" (click)="volver()">← Volver</button>
    <h2>Detalle de Proceso</h2>
  </div>

  <div *ngIf="cargando">Cargando...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!cargando && proceso" class="card">
    <div class="hdr">
      <div class="title">
        <h3>{{ proceso.nombre }}</h3>

        <div class="meta">
          <span *ngIf="proceso.numeroExpediente"><strong>Expte:</strong> {{ proceso.numeroExpediente }}</span>
          <span *ngIf="proceso.tipoActo"> · <strong>Tipo:</strong> {{ proceso.tipoActo }}</span>
          <span *ngIf="caso"> · <strong>Caso:</strong> {{ caso }}</span>
          <span [class]="badgeClass(proceso.estado)"> {{ estadoLabel(proceso.estado) }} </span>
        </div>
      </div>

      <div class="avance">
        <div class="pct">{{ avancePct }}%</div>
        <div class="small">{{ completos }} / {{ totalAplicables }} completos</div>
      </div>
    </div>

    <div class="block" *ngIf="situacionActual">
      <h4>Situación actual</h4>
      <p class="muted one-line">{{ situacionActual }}</p>
    </div>

    <div class="block" *ngIf="puntosPrincipales">
      <h4>Puntos principales</h4>
      <p class="muted">{{ puntosPrincipales }}</p>
    </div>
  </div>

  <div class="card">
    <div class="hdr2">
      <h3>Requisitos</h3>

      <form [formGroup]="nuevoReqForm" (ngSubmit)="crearRequisito()" class="new-req">
        <input class="input" formControlName="descripcion" placeholder="Nuevo requisito (descripción)" />
        <button class="btn primary" type="submit" [disabled]="nuevoReqForm.invalid">Agregar</button>
      </form>
    </div>

    <div *ngIf="cargandoReq">Cargando requisitos...</div>
    <div *ngIf="errorReq" class="error">{{ errorReq }}</div>

    <table class="tabla" *ngIf="!cargandoReq && requisitos.length">
      <thead>
        <tr>
          <th>#</th>
          <th>Requisito / Documento</th>
          <th>Aplica</th>
          <th>Estado</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
  <tr *ngFor="let r of requisitos">
    <td class="num">{{ r.orden }}</td>
    <td class="desc">{{ r.descripcion }}</td>

    <td class="center">
      <input
        #chk
        type="checkbox"
        [checked]="r.aplica"
        (change)="onAplicaChange(r, chk.checked)"
      />
    </td>

    <td>
      <select
        #sel
        class="input sm"
        [value]="r.estado"
        (change)="onEstadoChange(r, sel.value)"
      >
        <option value="pendiente">Pendiente</option>
        <option value="en_gestion">En gestión</option>
        <option value="completo">Completo</option>
        <option value="no_aplica">No aplica</option>
      </select>
    </td>

    <td>
      <input
        #resp
        class="input sm"
        [value]="r.responsableTexto || ''"
        (blur)="guardarTexto(r, resp.value, (r.observaciones || ''))"
        placeholder="Responsable"
      />
    </td>

    <td>
      <input
        #obs
        class="input sm"
        [value]="r.observaciones || ''"
        (blur)="guardarTexto(r, (r.responsableTexto || ''), obs.value)"
        placeholder="Obs."
      />
    </td>

    <td class="actions">
      <button class="btn danger sm" (click)="eliminarRequisito(r)">Eliminar</button>
    </td>
  </tr>
</tbody>

    </table>

    <div class="muted" *ngIf="!cargandoReq && !requisitos.length">
      Sin requisitos cargados todavía.
    </div>
  </div>
</div>
