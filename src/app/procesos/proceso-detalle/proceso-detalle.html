<div class="wrap">
  <div class="topbar">
    <button class="btn" (click)="volver()">← Volver</button>
    <h2>Detalle de Proceso</h2>
  </div>

  <div *ngIf="cargando">Cargando...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div class="card" *ngIf="!cargando && proceso">
    <div class="head">
      <div>
        <h3>{{ proceso.nombre }}</h3>
        <div class="meta">
          <span *ngIf="proceso.numeroExpediente"><strong>Expte:</strong> {{ proceso.numeroExpediente }}</span>
          <span *ngIf="proceso.tipoActo"> · <strong>Tipo:</strong> {{ proceso.tipoActo }}</span>
          <span *ngIf="caso"> · <strong>Caso:</strong> {{ caso }}</span>
          <span [class]="badgeClass(proceso.estado)">{{ estadoLabel(proceso.estado) }}</span>
        </div>
      </div>

      <div class="avance">
        <div class="pct">{{ avancePct }}%</div>
        <div class="small">{{ completos }} / {{ totalAplicables }} completos</div>
      </div>
    </div>

    <div class="block" *ngIf="situacionActual">
      <div class="label">Situación actual</div>
      <div class="text">{{ situacionActual }}</div>
    </div>

    <div class="block" *ngIf="puntosPrincipales">
      <div class="label">Puntos principales</div>
      <div class="text small">{{ puntosPrincipales }}</div>
    </div>
  </div>

  <div class="card" *ngIf="!cargando && proceso">
    <div class="row between">
      <h3>Requisitos</h3>

      <div class="tools">
        <select class="input sm" #psel (change)="plantillaSeleccionada = psel.value">
          <option value="">Aplicar plantilla...</option>
          <option *ngFor="let p of plantillas" [value]="p.codigo">{{ p.nombre }}</option>
        </select>
        <button class="btn sm" type="button" (click)="aplicarPlantilla()" [disabled]="!plantillaSeleccionada">
          Aplicar
        </button>
      </div>
    </div>

    <div class="row add">
      <form [formGroup]="nuevoReqForm" (ngSubmit)="agregarRapido()" class="inline">
        <input class="input" formControlName="descripcion" placeholder="Nuevo requisito (descripción)" />
        <button class="btn primary" type="submit" [disabled]="nuevoReqForm.invalid">Agregar</button>
      </form>
    </div>

    <div class="tablewrap">
      <table class="tabla">
        <thead>
          <tr>
            <th style="width: 48px;">#</th>
            <th>Requisito / Documento</th>
            <th style="width: 90px;">Aplica</th>
            <th style="width: 140px;">Estado</th>
            <th style="width: 180px;">Responsable</th>
            <th style="width: 220px;">Observaciones</th>
            <th style="width: 110px;"></th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of requisitos">
            <td>{{ r.orden }}</td>

            <td class="desc">{{ r.descripcion }}</td>

            <td>
              <input
                type="checkbox"
                [checked]="r.aplica !== false"
                (change)="onAplicaChange(r, pselAplica.checked)"
                #pselAplica
              />
            </td>

            <td>
              <select class="input sm"
                      [value]="r.estado"
                      (change)="onEstadoChange(r, ($any($event.target).value))">
                <option *ngFor="let e of estados" [value]="e.value">{{ e.label }}</option>
              </select>
            </td>

            <td>
              <input class="input sm"
                     [value]="r.responsableTexto || ''"
                     (blur)="guardarTexto(r, ($any($event.target).value), r.observaciones || '')"
                     placeholder="Responsable" />
            </td>

            <td>
              <input class="input sm"
                     [value]="r.observaciones || ''"
                     (blur)="guardarTexto(r, r.responsableTexto || '', ($any($event.target).value))"
                     placeholder="Obs." />
            </td>

            <td>
              <button class="btn danger sm" type="button" (click)="eliminarReq(r)">Eliminar</button>
            </td>
          </tr>

          <tr *ngIf="!requisitos.length">
            <td colspan="7" class="muted">Sin requisitos aún.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
